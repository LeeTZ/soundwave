
<!DOCTYPE html>
<meta charset="utf-8">
<style>

body {
  font: 10px sans-serif;
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.x.axis path {
  display: none;
}

.line {
  fill: none;
  stroke: steelblue;
  stroke-width: 1.5px;
}

</style>
    <title>City Sound Map - Shilin Fan's Project</title>
    <link rel="stylesheet" href="css/TenderNoise.css" type="text/css">
    <script src="js/jquery.min.js" type="text/javascript"></script>
    <script src="js/d3.min.js"></script>

<script>
  // IE detection 
  var IE = /*@cc_on!@*/false;
    function showAboutUs()
    {
        $('#aboutUsPanel').show();
    }
    
    
    function hideAboutUs()
    {
        $('#aboutUsPanel').hide();
    }
    
   
    $(document).ready(function() 
    {
        $('#header #aboutUs').click(showAboutUs);
        $('#aboutUsPanel #content').click(hideAboutUs);
        // $('#aboutUsPanel').show();        
    });
</script>


</head>


<body>

  
        <div id="header">
            <div id="logo">
                <img src="images/logo-tn.png">
            </div>
            <div id="caption">
                Do you know the impact of noise around us?
            </div>
            <div id="feedback"><a href="playground.html"  style="text-decoration:none; color: white;">Playground</a></div>
            <div id="separator"></div>
            <div id="aboutUs">About<img style="margin-left:3px;" src="images/arrow.png"></div>
            <div id="separator"></div>
            <div id="movityLink" style="font-size:12px; font-style:italic; color:#999; margin-top:28px;">Created by Shilin Fan</div>
        </div>

        <div id="aboutUsPanel" style="display:none;">
            <div id="transparent">
            </div>

            <div id="content">
                <span id="aboutUsPanelHeading">About Me</span> <span style="float:right; cursor:pointer;"> <a style="color: white;">[x]</a> </span>
                <div class="horizontalLine"></div>
                <p>City Sound Map is a brand that aims to improve lifestyles in big cities, as the increasing sound pollution has having an impact on citizens health. The app allow users to visualise cities sound and noise in terms of quality and loudness.</p>
                    <p>
                      Created by <a href="mailto:1904918886@qq.com">Shilin Fan</a>
                      </p><p>
                      Tech supported by <a href="mailto:litiezheng513@gmail.com">Tiezheng Li</a>
                    </p>
                <div class="clearboth"></div>
            </div>
        </div>





<svg width="1200" height="500" style="display:block;">
 <image x="20" y="0" width="900" height="480" xlink:href="images/dorm.jpg"/>
 <image id="c1" x="180" y="90" width="50" height="50" xlink:href="images/green.png"/>
 <image id="c2" x="180" y="370" width="50" height="50" xlink:href="images/green.png"/>
 <image id="c3" x="420" y="90" width="50" height="50" xlink:href="images/green.png"/>
 <image id="c4" x="420" y="370" width="50" height="50" xlink:href="images/green.png"/>
 <image id="c5" x="100" y="250" width="50" height="50" xlink:href="images/green_normal.png"/>
 <image id="c6" x="700" y="220" width="50" height="50" xlink:href="images/green_work.png"/>
 <image id="me" x="520" y="170" width="60" height="60" xlink:href="images/me.png"/>

   <text id="c1text" x="180" y="90" text-anchor="middle" font-family="Georgia" font-size="18px" fill="white">20.34</text>
   <text id="c2text" x="180" y="370" text-anchor="middle" font-family="Georgia" font-size="18px" fill="white">20.34</text>
   <text id="c3text" x="420" y="90" text-anchor="middle" font-family="Georgia" font-size="18px" fill="white">20.34</text>
   <text id="c4text" x="420" y="370" text-anchor="middle" font-family="Georgia" font-size="18px" fill="white">20.34</text>
   <text id="c5text" x="100" y="250" text-anchor="middle" font-family="Georgia" font-size="18px" fill="white">20.34</text>
   <text id="c6text" x="520" y="170" text-anchor="middle" font-family="Georgia" font-size="18px" fill="white">20.34</text>
   <text id="displaytext" x="20" y="500" font-family="Arial" font-size="26px" fill="White">Hi</text>
</svg>

<div class="buttons" style="display:block; margin-left:280px;" >
<input id="playbutton" type="button" value="play"/>
<input id="stopbutton" type="button" value="stop"/>
<input id="replaybutton" type="button" value="replay"/>
</div>
<svg  width="200" height="250">
  <image x="30" y="35" width="20" height="20" xlink:href="images/green.png"/>
  <image x="27" y="65" width="25" height="25" xlink:href="images/pink.png"/>
  <image x="25" y="100" width="30" height="30" xlink:href="images/red.png"/>
  <image x="22" y="140" width="35" height="35" xlink:href="images/orange.png"/>
  <image x="30" y="185" width="20" height="20" xlink:href="images/red_work.png"/>
  <image x="30" y="220" width="20" height="20" xlink:href="images/green_normal.png"/>
  <text x="30" y="23" font-family="Arial" font-size="24px" fill="White"> Legend</text>
  <text x="75" y="50" font-family="Arial" font-size="14px" fill="White"> &lt; 70 dB</text>
  <text x="75" y="82" font-family="Arial" font-size="14px" fill="White"> 70 - 90 dB</text>
  <text x="75" y="120" font-family="Arial" font-size="14px" fill="White"> 90 - 100 dB</text>
  <text x="75" y="160" font-family="Arial" font-size="14px" fill="White"> &gt; 100 dB</text>
  <text x="75" y="200" font-family="Arial" font-size="14px" fill="White"> work sound</text>
  <text x="75" y="235" font-family="Arial" font-size="14px" fill="White"> natrual sound</text>
</svg>
<script>
// 对Date的扩展，将 Date 转化为指定格式的String 
// 月(M)、日(d)、小时(h)、分(m)、秒(s)、季度(q) 可以用 1-2 个占位符， 
// 年(y)可以用 1-4 个占位符，毫秒(S)只能用 1 个占位符(是 1-3 位的数字) 
// 例子： 
// (new Date()).Format("yyyy-MM-dd hh:mm:ss.S") ==> 2006-07-02 08:09:04.423 
// (new Date()).Format("yyyy-M-d h:m:s.S")      ==> 2006-7-2 8:9:4.18 
Date.prototype.Format = function(fmt) 
{ //author: meizz 
  var o = { 
    "M+" : this.getMonth()+1,                 //月份 
    "d+" : this.getDate(),                    //日 
    "h+" : this.getHours(),                   //小时 
    "m+" : this.getMinutes(),                 //分 
    "s+" : this.getSeconds(),                 //秒 
    "q+" : Math.floor((this.getMonth()+3)/3), //季度 
    "S"  : this.getMilliseconds()             //毫秒 
  }; 
  if(/(y+)/.test(fmt)) 
    fmt=fmt.replace(RegExp.$1, (this.getFullYear()+"").substr(4 - RegExp.$1.length)); 
  for(var k in o) 
    if(new RegExp("("+ k +")").test(fmt)) 
  fmt = fmt.replace(RegExp.$1, (RegExp.$1.length==1) ? (o[k]) : (("00"+ o[k]).substr((""+ o[k]).length))); 
  return fmt; 
}

var margin = {top: 10, right: 80, bottom: 30, left: 60},
    width = 900 - margin.left - margin.right,
    height = 250 - margin.top - margin.bottom;

var parseDate = d3.time.format("%Y%m%d").parse;
var parseTime = d3.time.format("%H:%M:%S").parse;

var x = d3.time.scale()
    .range([0, width]);

var y = d3.scale.linear()
    .range([height, 0]);

var color = d3.scale.category10();

var xAxis = d3.svg.axis()
    .scale(x)
    .orient("bottom");

var yAxis = d3.svg.axis()
    .scale(y)
    .orient("left");

var line = d3.svg.line()
    .interpolate("basis")
    .x(function(d) { return x(d.date); })
    .y(function(d) { return y(d.temperature); });

var svg = d3.select("body").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

var thedata;
var timeline;
d3.csv("data/dorm.csv", function(error, data) {
  color.domain(d3.keys(data[0]).filter(function(key) { return key !== "Time"; }));

  data.forEach(function(d) {
    d.date = parseTime(d.Time);
  });

  var cities = color.domain().map(function(name) {
    return {
      name: name,
      values: data.map(function(d) {
        return {date: d.date, temperature: +d[name]};
      })
    };
  });

  thedata = cities;
  x.domain(d3.extent(data, function(d) { return d.date; }));

  y.domain([
    d3.min(cities, function(c) { return d3.min(c.values, function(v) { return v.temperature; }); }),
    d3.max(cities, function(c) { return d3.max(c.values, function(v) { return v.temperature; }); })
  ]);

  svg.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height + ")")
      .attr("fill","white")
      .style("stroke", "white")
      .call(xAxis);

  svg.append("g")
      .attr("class", "y axis")
      .attr("fill","white")
      .style("stroke", "white")
      .call(yAxis)
    .append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", 6)
      .attr("dy", ".71em")
      .attr("fill","white")
      .style("text-anchor", "end")
      .style("stroke", "white")
      .text("Noise (dB)");

  var city = svg.selectAll(".city")
      .data(cities)
    .enter().append("g")
      .attr("class", "city");

  city.append("path")
      .attr("class", "line")
      .attr("d", function(d) { return line(d.values); })
      .style("stroke", function(d) { return color(d.name); });

  city.append("text")
      .datum(function(d) { return {name: d.name, value: d.values[d.values.length - 1]}; })
      .attr("transform", function(d) { return "translate(" + x(d.value.date) + "," + y(d.value.temperature) + ")"; })
      .attr("x", 3)
      .attr("dy", ".35em")
      .attr("fill","white")
      .text(function(d) { return d.name; });

  timeline = svg.append("line")
                    .attr("id","timeline")
                    .attr("x1",5)
                    .attr("y1",5)
                    .attr("x2",5)
                    .attr("y2",285)
                    .attr("stroke-width", 3)
                    .attr("stroke", "white");
});

function getcolor(db){
    if (db < 70)
      return "images/green.png";
    else if (db < 90)
      return "images/pink.png";
    else if (db < 100)
      return "images/red.png";
    else return "images/orange.png"; 
}

function getcolor2(db){
    if (db < 70)
      return "images/green_work.png";
    else if (db < 90)
      return "images/pink_work.png";
    else if (db < 100)
      return "images/red_work.png";
    else return "images/orange_work.png"; 
}

function getcolor3(db){
    if (db < 70)
      return "images/green_normal.png";
    else if (db < 90)
      return "images/pink_normal.png";
    else if (db < 100)
      return "images/red_normal.png";
    else return "images/orange_normal.png"; 
}


var timeindex = 0;
var scale = 0.75;
var showtime = new Date(2014,12,4,19,34,44,474);
var timer = null;
var nowplaying = false;


function drawcircle(object,objecttext,rank,x,y,type){
   var r0 = thedata[rank].values[timeindex].temperature;
   d3.select(object).attr("width",r0*scale);
   d3.select(object).attr("height",r0*scale);
   if (type == 1)
      d3.select(object).attr("xlink:href",getcolor(r0));
   else if (type == 2)
      d3.select(object).attr("xlink:href",getcolor2(r0));
   else 
      d3.select(object).attr("xlink:href",getcolor3(r0));
   d3.select(object).attr("x",x - r0*scale / 2);
   d3.select(object).attr("y",y - r0*scale / 2);
   d3.select(objecttext).text(Math.floor(r0));
}




$("#playbutton").click(function(){
  if (nowplaying)
       return;
   nowplaying = true;
   timer = setInterval(function(){
   
   drawcircle("#c1","#c1text",0,180,90,1);
   drawcircle("#c2","#c2text",1,180,370,1);
   drawcircle("#c3","#c3text",2,420,90,1);
   drawcircle("#c4","#c4text",3,420,370,1);
   drawcircle("#c5","#c5text",4,100,250,3);
   drawcircle("#c6","#c6text",5,700,220,2);

   d3.select("#me").attr("x", (340 + (timeindex / 10)));

   d3.select("#displaytext").text("At " + showtime.Format("hh:mm:ss") + ", the average noise is " + thedata[0].values[timeindex].temperature.toString() + " dB");
   d3.select("#timeline").attr("x1",Math.floor(5 + timeindex*2.9));
   d3.select("#timeline").attr("x2",Math.floor(5 + timeindex*2.9));
   timeindex++;
   showtime.setSeconds(showtime.getSeconds()+1);
   if (timeindex >= 301) inta=window.clearInterval(inta);
}, 100);

});


$("#playbutton").click();

$("#stopbutton").click(function(){
    if (!nowplaying)
       return;
    nowplaying = false; 
    clearInterval(timer);
    timer = null;
});

$("#replaybutton").click(function(){
  timeindex = 0;
  showtime = null;
  showtime = new Date(2014,12,4,19,34,45,474);
  $("#stopbutton").click();
  $("#playbutton").click();
});

</script>
